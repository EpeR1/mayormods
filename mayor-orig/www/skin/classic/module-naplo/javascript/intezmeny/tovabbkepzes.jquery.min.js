$(function() {

    var sumOsszeg=0;
    var sumTamogatas=0;
    var sumOsszeg_ok=0;
    var sumTamogatas_ok=0;

    checkTamogatasInput();
    $('#ujTovabbkepzes span.ujIntezmeny').click(function() {
	var h = 'Intézmény rövidneve: <input type="text" name="intezmenyRovidNev" /> ';
	    h += 'Intézmény neve: <input type="text" name="intezmenyNev"  style="width:200px;"/>';
	$(this).after(h);
	$('#ujTovabbkepzes span.ujIntezmeny').remove();
	$('#ujTovabbkepzes select').hide();
    });

    $('#tovabbkepzesTerv input[type=text].currency').change(function() {
	element = $(event.target);
	checkTamogatasInput();
    });

    $('#tanarTovabbkepzesForduloDt select').click(function() {
	$(this).closest('form').find('input').removeClass('ajaxDone').removeClass('ajaxError');
    });
    $('#tanarTovabbkepzesForduloDt select').change(function() {
	$(this).next('input').val($(this).val());
	ajaxSetTanarAdat(
	    $(this).data('tanarid'),
	    $(this).val(),
	    $(this).closest('form').find('input.salt').attr('name'), 
	    $(this).closest('form').find('input.salt').val()
	);
	console.log($(this).closest("tr").find('th').html('<button type="submit"><span class="icon-repeat" style="font-size:10px;"></span></button>'));
    });

    $('#tovabbkepzesNavi button').click(function() {
	idToOpen = $(this).data('nav');
	if (idToOpen=='') $('#tovabbkepzesNavi').siblings('form').fadeIn();
	else {
	    $('#tovabbkepzesNavi').siblings('form').fadeOut();
    	    $('#'+idToOpen).fadeIn();
	}
    });

/*    $('#tanarTovabbkepzesForduloDt th.tovabbkepzesCiklus').each(function(i) {
	//enum('terv','jóváhagyott','elutasított','megszűnt','megszakadt','teljesített') ;
	$this = $(this);
	terv = (parseFloat($(this).data('terv'))||0);
	teljesitett = (parseFloat($(this).data('teljesített'))||0);
	jovahagyott = (parseFloat($(this).data('jóváhagyott'))||0);
	$this.find('span.terv').css({'width':terv+'px'});
	$this.find('span.teljesitett').css({'width':teljesitett+'px'});
	$this.find('span.jovahagyott').css({'width':jovahagyott+'px'});
    });
*/

    google.load("visualization", "1.1", {callback:drawCharts,language:'hu',packages:["corechart","timeline"]});
    /* -------------------------------------------------------------- */    
    function drawIdovonal() {
        var container = document.getElementById('timeline');
        var chart = new google.visualization.Timeline(container);
        var dataTable = new google.visualization.DataTable();
        dataTable.addColumn({ type: 'string', id: 'tovabbkepzes' });
        dataTable.addColumn({ type: 'string', id: 'oraszam' });
        dataTable.addColumn({ type: 'date', id: 'tolDt' });
        dataTable.addColumn({ type: 'date', id: 'igDt' });

	$('table.tovabbkepzes tbody tr.tovabbkepzesTanarSor').each(function(i) {
	    if ($(this).data('igdt')!='0000-00-00') {
	    var tanarNev = $(this).data('tanarnev');
	    var oraszam = $(this).data('oraszam') + " óra";
	    var tolDt = new Date( $(this).data('toldt')  );
	    var igDt = new Date( $(this).data('igdt')  );
    	    	dataTable.addRows([ [tanarNev, oraszam, tolDt, igDt] ]);
	    }
	});
        chart.draw(dataTable);
    }
    /* -------------------------------------------------------------- */    
    function drawPie1() {
        var data = google.visualization.arrayToDataTable([
          ['Task', 'Támogatás'],
          ['Nem támogatott', sumOsszeg-sumTamogatas],
          ['Támogatott',     sumTamogatas]
        ]);

        var options = {
	    title: 'Támogatás',
	    slices: { 0: { color: 'red'}, 1: { color: 'green'} },
	    legend: {position: 'bottom', textStyle: {color: 'black', fontSize: 10}}
	};
        var chart = new google.visualization.PieChart(document.getElementById('grafikonTamogatas'));
        chart.draw(data, options);
    }
    function drawPie2() {

        var dataTable = new google.visualization.DataTable();
	dataTable.addColumn('string', 'tanár');
	dataTable.addColumn('number', 'támogatás');
	$('table.tovabbkepzes tbody tr.tovabbkepzesTESor').each(function(i) {
	    if ($(this).data('igdt')!='0000-00-00') {
	    var tanarNev = $(this).data('tanarnev');
	    var reszosszeg = Number($(this).data('reszosszeg'));
	    var tamogatas = $(this).data('tamogatas');
    	    	dataTable.addRows([ [ tanarNev, reszosszeg  ] ]);
	    }
	});
        var options = {
	    title: 'Továbbképzések eloszlása összeg szerint',
	    pieSliceText: '',
	    legend: {position: 'labeled', textStyle: {color: 'black', fontSize: 10}}
	};
        var chart = new google.visualization.PieChart(document.getElementById('grafikonOsszegEloszlas'));
        chart.draw(dataTable, options);
    }
    /* -------------------------------------------------------------- */    
    function checkTamogatasInput() {
	sumOsszeg=0;
	sumTamogatas=0;
	sumOsszeg_ok=0;
	sumTamogatas_ok=0;
	$('#tovabbkepzesTerv tbody input[type=text].currency').each(function(index) {
	element = $(this);
	if (element.data('inputtype') == 'tamogatas') {
	    if (Number($('#reszosszeg_'+element.data('kulcs')).val()) < Number(element.val())) {
		element.addClass('hiba');
	    } else {
		element.removeClass('hiba');
	    }
	    if ($.inArray(element.data('tovabbkepzesstatusz'),['terv','jóváhagyott','teljesített'])>=0) {
		sumTamogatas_ok += Number(element.val());    
	    }
	    sumTamogatas += Number(element.val());    
	} else {
	    if ($.inArray(element.data('tovabbkepzesstatusz'),['terv','jóváhagyott','teljesített'])>=0)
		sumOsszeg_ok += Number(element.val());
	    sumOsszeg += Number(element.val());
	}
	});
	$('#sumOsszeg').val(sumOsszeg);
	$('#sumTamogatas').val(sumTamogatas);
	$('#sumOsszeg_ok').val(sumOsszeg_ok);
	$('#sumTamogatas_ok').val(sumTamogatas_ok);

	var keretOsszeg = Number($('#keretOsszeg').val());
	if (keretOsszeg<sumTamogatas_ok) {
	    $('#sumTamogatas_ok').addClass('hiba');
	    $('#tamogatasInfo').html('<span style="color:red">'+(keretOsszeg-sumTamogatas_ok)+' Ft.-</span>');
	} else {
	    $('#sumTamogatas_ok').removeClass('hiba');
	    if ((keretOsszeg-sumTamogatas_ok)==0) $('#tamogatasInfo').html('');
	    else $('#tamogatasInfo').html('<span style="color:green">'+(keretOsszeg-sumTamogatas_ok)+' Ft.-</span>');
	}
    }
    /* -------------------------------------------------------------- */    

    function drawCharts() {
	drawIdovonal();
	if ($('#grafikonTamogatas').length>0) drawPie1();
	if ($('#grafikonOsszegEloszlas').length>0) drawPie2();
    }

    var clickedMegjegyzes = false;
    $('span.tovabbkepzesMegjegyzes').click(function() {
	clickedMegjegyzes = $(this).parent('td');
	$('#updateForm').html($('#tovabbkepzesMegjegyzes_'+$(this).data('kulcs')+""));
	$('#updateForm *').show();
	$('#takaro').show();
	$('#updateWindow').show();
    });

    hideUpdateLayer = function() {
	$('#updateForm div').hide();
	clickedMegjegyzes.append($('#updateForm div'));
    };

});



ajaxSetTanarAdat = function(tanarId,forduloDt,salt_name,salt_value) {
    postData = {'tanarId':tanarId, 
		'forduloDt':forduloDt,
		'sessionID': $('body').data('sessionid'), 
		'action':'modTanarTovabbkepzesForduloDt' }
    postData[salt_name] = salt_value;
    $.ajax({
                    type: "POST",
                    url: "index.php?page=naplo&sub=intezmeny&f=tovabbkepzes&policy=private&skin=ajax&sessionID="+$('body').data('sessionid'),
                    data: postData,
                    dataType: 'json'
    }).done(function( msg, status, jqXHR ) {
                updateSalt(jqXHR.getResponseHeader('Etag'));
        	processJSONTovabbkepzes(msg);
    }).fail(function( jqXHR, textStatus, errorThrown ) {
                //console.log(errorThrown);
		//console.log(jqXHR.responseJSON);
                //displayJSONerror(jqXHR.responseJSON);
                updateSalt(jqXHR.getResponseHeader('Etag'));
		triggerError(tanarId);
    });
}

processJSONTovabbkepzes = function (ADAT) {
    $('input[data-tanarid='+(ADAT.tanarId)+']').addClass('ajaxDone');
}

triggerError = function (tanarId) {
    $('input[data-tanarid='+(tanarId)+']').addClass('ajaxError');
}
