$(function() {

    displayJSONerror = function(json) {                
	alert(JSON.stringify(json));            
    }

    checkOraszam = function(plusz, minusz) {
	$('table#tt td.lekotott').each(function(index) {
	    checkTanarOraszam($(this), plusz, minusz, false);
	});
	$('table#tt span#keszTanarDb').html($('table#tt tr.ok').length);
    }

    checkTanarOraszam = function(lekotottTd, plusz, minusz, dbFrissit) {
	    lekotott = parseFloat(lekotottTd.find('span.lekotott').html().replace(',','.'));
	    kotelezo = parseFloat(lekotottTd.find('span.kotelezo').html().replace(',','.'));
	    if (lekotott<kotelezo-minusz) lekotottTd.closest('tr').removeClass('ok').removeClass('plusz').addClass('minusz');
	    else if (lekotott>kotelezo+plusz) lekotottTd.closest('tr').removeClass('ok').removeClass('minusz').addClass('plusz');
	    else lekotottTd.closest('tr').removeClass('minusz').removeClass('plusz').addClass('ok');

	    if (dbFrissit) $('table#tt span#keszTanarDb').html($('table#tt tr.ok').length);
    }

    ajaxGetTankorAdat_tth = function(tankorId) {
        postData = { 'tankorId':tankorId, 'mayorToken': $('body').data('mayortoken') }

        $.ajax({
	    type: "POST",
	    url: "index.php?page=naplo&sub=tools&f=getTankorAdat&policy=private&skin=ajax&sessionID="+$('body').data('sessionID'),
	    data: postData,
	    dataType: 'json'
        }).done(function( msg, status, jqXHR ) {
	    processJSONTankorAdat_tth(msg);
            updateSalt(jqXHR.getResponseHeader('Etag'));
	}).fail(function( jqXHR, textStatus, errorThrown ) {
	    //console.log('fail');
	    //console.log(jqXHR);
            updateSalt(jqXHR.getResponseHeader('Etag'));
        });
    }

    processJSONTankorMod = function( msg ) {
	// console.log(JSON.stringify(msg));
	$('#updateWindowSide').data('target').html(msg.tankorNevTargyNelkul);
	processJSONTankorAdat( msg );
    }

    processJSONTankorAdat_tth = function( msg ) {
	//console.log(JSON.stringify(msg));
	
	$('#updateWindowSideContent').html('');
	$('#updateWindowSideTitle').html('Tantárgyfelosztás - Tankör');
	$('<p class="tankorNev">'	+msg.tankorNevReszei.evfOszt+' '
				    +msg.tankorNevReszei.targyNev
				    +(msg.tankorNevReszei.tankorJel!=''&&msg.tankorNevReszei.tankorJel!=null?msg.tankorNevReszei.tankorJel+' ':'')
				    +' <span class="tankorNevExtra">'+msg.tankorNevReszei.tankorNevExtra+'</span>'
				    +'<input id="tankorNevExtra" type="text" name="tankorNevExtra" value="'+msg.tankorNevReszei.tankorNevExtra+'" />'
				    +' ('+msg.tankorId+')</p>').appendTo('#updateWindowSideContent');
	$('<p class="tankorModosit">Módosít!</p>').appendTo('#updateWindowSideContent');
	// adatok
	ulStr = '<ul>'
	    +'<li>Évközi követelmény: '+msg.kovetelmeny+'</li>'
	    +'<li>Létszám korlát: '+msg.min+'-'+msg.max+'</li>'
	    +'<li>Tankör-típus: '+msg.rovidNev+' ('+msg.tankorTipusId+')</li>'
	    +'</ul>';
	$(ulStr).appendTo('#updateWindowSideContent');
	// osztályok
	ulStr = '<ul id="tankorOsztaly">';
	pStr = '<div class="slideToggleContainer" id="pTankorOsztaly">Osztályai: <span class="tankorData slideToggle">';
	for (i=0; i<msg.osztalyok.length; i++) {
	    ulStr += '<li>'
		    +'<input type="checkbox" name="osztalyId[]" value="'+msg.osztalyok[i].osztalyId+'" id="oTankorId-'+msg.osztalyok[i].osztalyId+'" ';
	    if ($.inArray(msg.osztalyok[i].osztalyId, msg.osztalyIds)>-1) {
		ulStr += 'checked="checked" ';
		pStr += msg.osztalyok[i].osztalyJel+' ('+msg.osztalyok[i].osztalyId+') ';
	    }
	    ulStr += '/> '
	    +'<label for="oTankorId-'+msg.osztalyok[i].osztalyId+'">'+msg.osztalyok[i].osztalyJel+' ('+msg.osztalyok[i].osztalyId+')</label></li>';
	}
	ulStr += '</ul>';
	pStr += '</span><span class="icon-chevron-down slideToggle"></span>'+ulStr+'</div>';
	$(pStr).appendTo('#updateWindowSideContent');
	// szemeszterek, óraszámok
	ulStr = '<ul id="tankorSzemeszter">';
	for (i=0; i<msg.tankorSzemeszter.length; i++) {
	    ulStr += '<li>'+msg.tankorSzemeszter[i].tanev+'/'+msg.tankorSzemeszter[i].szemeszter
		+'<input maxlength="5" type="text" name="sz-'+msg.tankorSzemeszter[i].tanev+'-'+msg.tankorSzemeszter[i].szemeszter+'" value="'+msg.tankorSzemeszter[i].oraszam+'" />'
		+'</li>';
	}
	ulStr += '</ul>';
	pStr = '<div class="slideToggleContainer" id="pTankorSzemeszter">Óraszám: <span class="tankorData slideToggle">'+msg.oraszam+' ('+msg.tanev+'/'+msg.szemeszter+')</span>'
		+'<span class="icon-chevron-down slideToggle"></span>'
		+ulStr
		+'</div>';
	$(pStr).appendTo('#updateWindowSideContent');
		
	$('#updateWindowSideSub').removeClass('nyitva');
	if (!$('#updateWindowSide').hasClass('nyitva')) {
	    $('#updateWindowSide').addClass('nyitva');
	}

    }

    processJSONChk = function(msg, element, tanarId, tankorId) {
	// console.log(JSON.stringify(msg));
	tankorTd = $('td#col_'+tankorId);
	if (element.prop('checked')) {
	    oraPerFo = (parseFloat(tankorTd.data('oraszam').replace(',','.'))/parseInt(tankorTd.data('tanardb')));
	    $('table#tt td.col-'+tankorId+' input:checked').each(function(index) {
		if ($(this).val() != element.val()) {
		    lSpan = $(this).closest('tr').find('span.lekotott');
		    lekot = parseFloat(lSpan.html().replace(',','.'))-oraPerFo;
		    lSpan.html(lekot.toString().replace('.',','));
		}
	    });
	    if (!tankorTd.hasClass('kesz')) {
		tankorTd.addClass('kesz');
		db = parseInt($('table#tt span#keszTankorDb').html());
		$('table#tt span#keszTankorDb').html(++db);
	    } else { tankorTd.removeClass('kesz').addClass('tobb') }
	    tankorTd.data('tanardb', parseInt(tankorTd.data('tanardb'))+1);
	    oraPerFo = (parseFloat(tankorTd.data('oraszam').replace(',','.'))/parseInt(tankorTd.data('tanardb')));
	    plusz=parseInt($('div#statusz span#plusz').html());
	    minusz=parseInt($('div#statusz span#minusz').html());
	    $('table#tt td.col-'+tankorId+' input:checked').each(function(index) {
		{
		    lSpan = $(this).closest('tr').find('span.lekotott');
		    lekot = parseFloat(lSpan.html().replace(',','.'))+oraPerFo;
		    lSpan.html(lekot.toString().replace('.',','));
		    checkTanarOraszam(lSpan.closest('td'), plusz, minusz, true);
		}
	    });
	} else {
	    oraPerFo = (parseFloat(tankorTd.data('oraszam').replace(',','.'))/parseInt(tankorTd.data('tanardb')));
	    lSpan = element.closest('tr').find('span.lekotott');
	    lekot = parseFloat(lSpan.html().replace(',','.'))-oraPerFo;
	    lSpan.html(lekot.toString().replace('.',','));
	    $('table#tt td.col-'+tankorId+' input:checked').each(function(index) {
		{
		    lSpan = $(this).closest('tr').find('span.lekotott');
		    lekot = parseFloat(lSpan.html().replace(',','.'))-oraPerFo;
		    lSpan.html(lekot.toString().replace('.',','));
		}
	    });
	    if ($('table#tt td.col-'+tankorId+' input:checked').length == 0) {
		tankorTd.removeClass('kesz');
		db = parseInt($('table#tt span#keszTankorDb').html());
		$('table#tt span#keszTankorDb').html(--db);
	    } else if ($('table#tt td.col-'+tankorId+' input:checked').length == 1) tankorTd.removeClass('tobb').addClass('kesz');
	    tankorTd.data('tanardb', parseInt(tankorTd.data('tanardb'))-1);
	    oraPerFo = (parseFloat(tankorTd.data('oraszam').replace(',','.'))/parseInt(tankorTd.data('tanardb')));
	    plusz=parseInt($('div#statusz span#plusz').html());
	    minusz=parseInt($('div#statusz span#minusz').html());
	    checkTanarOraszam(element.closest('tr').find('td.lekotott'), plusz, minusz, true);
	    $('table#tt td.col-'+tankorId+' input:checked').each(function(index) {
		if ($(this).val() != element.val()) {
		    lSpan = $(this).closest('tr').find('span.lekotott');
		    lekot = parseFloat(lSpan.html().replace(',','.'))+oraPerFo;
		    lSpan.html(lekot.toString().replace('.',','));
		}
		checkTanarOraszam($(this).closest('tr').find('td.lekotott'), plusz, minusz, true);
	    });
	}
        $('#cell_'+tanarId+'_'+tankorId).animate({backgroundColor: '#00ff00'}, 100).animate({backgroundColor: '#eeeeee'}, 1000);
    }



//////////////////////////////////ITT VOLT AZ ELEJE
    // TODO - ezt kivenni
    var params = $.parseParams(window.location.toString().split('?')[1] || '' );
    var sessionID=params.sessionID?params.sessionID:'';
    $('body').data('sessionID',sessionID); // ez nem lenne szukseges. lasd meg data-sessionid

    checkOraszam(2,2);

    $('body').click(function(event) {

	element = $(event.target);
	saltName = $('#updateForm input.salt').prop('name');
	saltValue = $('#updateForm input.salt').val();

	if (element.attr('id')=='szuro') {
	    $('#updateWindowSideTitle').html('Szűrés');

	    dStr = '<form method="post" action="">';
	    dStr += '<input type="hidden" class="salt" name="'+saltName+'" value="'+saltValue+'" />';
	    dStr += '<input type="hidden" class="mayorToken" name="mayorToken" value="'+ ($('body').data('mayortoken')) +'" />';
 
	    // Osztályok
	    ulStr = '<ul>'; spanStr = '';
	    for (i=0; i<$('#szuro').data('szuro').osztalyok.length; i++) {
		oAdat = $('#szuro').data('szuro').osztalyok[i];
		ulStr += '<li>'
			    +'<input class="szOsztaly" id="szOsztalyId-'+oAdat['osztalyId']+'" type="checkbox" name="osztalyIds[]" value="'+oAdat['osztalyId']+'"';
		if ($.inArray(parseInt(oAdat['osztalyId']), $('#szuro').data('szuro').osztalyIds)>-1) {
		    ulStr += ' checked="checked" ';
		    spanStr += '<span id="selOsztalyId-'+oAdat['osztalyId']+'"> '+oAdat['osztalyJel']+' ('+oAdat['osztalyId']+')</span>';
		}
		ulStr += '/><label for="szOsztalyId-'+oAdat['osztalyId']+'">'+oAdat['osztalyJel']+' ('+oAdat['osztalyId']+')</label></li>';
	    }
	    ulStr += '</ul>';
	    dStr += '<div id="szOsztaly" class="slideContainer">'
			+'<span class="slider icon-chevron-down"></span>'
			+'<span class="icon-minus-sign unset"></span> '
			+'<strong class="slider">Osztályok:</strong> '+spanStr;
	    dStr += ulStr;
	    dStr += '</div>';

	    // Munkaközösségek
	    ulStr = '<ul>'; spanStr = '';
	    for (i=0; i<$('#szuro').data('szuro').munkakozossegek.length; i++) {
		oAdat = $('#szuro').data('szuro').munkakozossegek[i];
		ulStr += '<li>'
			    +'<input class="szMk" id="szMkId-'+oAdat['mkId']+'" type="checkbox" name="mkIds[]" value="'+oAdat['mkId']+'"';
		if ($.inArray(parseInt(oAdat['mkId']), $('#szuro').data('szuro').mkIds)>-1) {
		    ulStr += ' checked="checked" ';
		    spanStr += '<br/><span id="selMkId-'+oAdat['mkId']+'"> '+oAdat['mkNev']+' ('+oAdat['mkId']+')</span>';
		}
		ulStr += '/><label for="szMkId-'+oAdat['mkId']+'">'+oAdat['mkNev']+' ('+oAdat['mkId']+')</label></li>';
	    }
	    ulStr += '</ul>';
	    dStr += '<div id="szMk" class="slideContainer">'
			+'<span class="slider icon-chevron-down"></span>'
			+'<span class="icon-minus-sign unset"></span> '
			+'<strong class="slider">Munkaközösségek:</strong> '+spanStr;
	    dStr += ulStr;
	    dStr += '</div>';

	    // Tárgyak
	    ulStr = '<ul>'; spanStr = '';
	    for (i=0; i<$('#szuro').data('szuro').targyak.length; i++) {
		oAdat = $('#szuro').data('szuro').targyak[i];
		ulStr += '<li>'
			    +'<input class="szTargy" id="szTargyId-'+oAdat['targyId']+'" type="checkbox" name="targyIds[]" value="'+oAdat['targyId']+'"';
		if ($.inArray(parseInt(oAdat['targyId']), $('#szuro').data('szuro').targyIds)>-1) {
		    ulStr += ' checked="checked" ';
		    spanStr += '<br/><span id="selTargyId-'+oAdat['targyId']+'"> '+oAdat['targyNev']+' ('+oAdat['targyId']+')</span>';
		}
		ulStr += '/><label for="szTargyId-'+oAdat['targyId']+'">'+oAdat['targyNev']+' ('+oAdat['targyId']+')</label></li>';
	    }
	    ulStr += '</ul>';
	    dStr += '<div id="szTargy" class="slideContainer">'
			+'<span class="slider icon-chevron-down"></span>'
			+'<span class="icon-minus-sign unset"></span> '
			+'<strong class="slider">Tárgyak:</strong> '+spanStr;
	    dStr += ulStr;
	    dStr += '</div>';

	    // Tanárok
	    ulStr = '<ul>'; spanStr = '';
	    ulStr += '<li class="tanarNelkuli">'
		+'<input class="szTanar" id="szTanarNelkuliTankorok" type="checkbox" name="tanarNelkuliTankorok" value="true"';
		if ( $('#szuro').data('szuro').tanarNelkuliTankorok ) {
		    ulStr += ' checked="checked" ';
		    spanStr += '<br/><span id="selTanarId-0">Tanár nélküli tankörök</span>';
		}
	    ulStr += '/><label for="szTanarNelkuliTankorok">Tanár nélküli tankörök</label></li>';

	    for (i=0; i<$('#szuro').data('szuro').tanarok.length; i++) {
		oAdat = $('#szuro').data('szuro').tanarok[i];
		ulStr += '<li>'
			    +'<input class="szTanar" id="szTanarId-'+oAdat['tanarId']+'" type="checkbox" name="tanarIds[]" value="'+oAdat['tanarId']+'"';
		if ($.inArray(parseInt(oAdat['tanarId']), $('#szuro').data('szuro').tanarIds)>-1) {
		    ulStr += ' checked="checked" ';
		    spanStr += '<br/><span id="selTanarId-'+oAdat['tanarId']+'"> '+oAdat['tanarNev']+' ('+oAdat['tanarId']+')</span>';
		}
		ulStr += '/><label for="szTanarId-'+oAdat['tanarId']+'">'+oAdat['tanarNev']+' ('+oAdat['tanarId']+')</label></li>';
	    }
	    ulStr += '</ul>';
	    dStr += '<div id="szTanar" class="slideContainer">'
			+'<span class="slider icon-chevron-down"></span>'
			+'<span class="icon-minus-sign unset"></span> '
			+'<strong class="slider">Tanárok:</strong> '+spanStr;
	    dStr += ulStr;
	    dStr += '</div>';



	    dStr += '<input type="submit" value="Szűrés" />';
	    dStr += '</form>';
	    $('#updateWindowSideContent').html('');
	    $(dStr).appendTo('#updateWindowSideContent');

	    $('#updateWindowSideSub').removeClass('nyitva');
	    $('#updateWindowSide').addClass('nyitva');

	} else if (element.hasClass('slideContainer') || element.hasClass('slideToggleContainer')) {
	    element.find('ul').slideToggle(75);
	    element.find('span.slider').toggleClass('icon-chevron-down').toggleClass('icon-chevron-up');
	} else if (element.hasClass('slider') || element.hasClass('slideToggle')) {
	    element.closest('div').find('ul').slideToggle(75);
	    element.closest('div').find('span.slider').toggleClass('icon-chevron-down').toggleClass('icon-chevron-up');
	} else if (element.hasClass('tankor')) {
	    // console.log(element);
	    $('#updateWindowSide').data('target',element);
	    ajaxGetTankorAdat_tth(element.data('tankorid'));
	} else if (element.hasClass('tankorNevExtra')) {
	    element.next('input#tankorNevExtra').show();
	    element.hide();
	} else if (element.hasClass('tankorModosit')) {
	    postData = { 'tankorId':$('#updateWindowSide').data('target').data('tankorid'),'osztalyIds': [], 'tankorSzemeszter': [], 'tankorNevExtra': $('#updateWindowSide input#tankorNevExtra').val() }
	    $('#updateWindowSide ul#tankorOsztaly input:checked').each(function(index){postData.osztalyIds.push($(this).val());})
	    $('#updateWindowSide ul#tankorSzemeszter input[type=text]').each(function(index){  
		if ($(this).val() != '') {
		    tmp = $(this).attr('name').split('-');
		    postData.tankorSzemeszter.push({'tanev':tmp[1], 'szemeszter': tmp[2], 'oraszam': $(this).val() });
		}
	    });

	    $.ajax({
	        type: "POST",
	        url: "index.php?page=naplo&sub=tools&f=tankorMod&policy=private&skin=ajax&sessionID="+sessionID,
	        data: postData,
	        dataType: 'json'
	    }).done(function( msg, status, jqXHR ) {
	        processJSONTankorMod(msg);
        	updateSalt(jqXHR.getResponseHeader('Etag'));
	    }).fail(function( jqXHR, textStatus, errorThrown ) {
        	updateSalt(jqXHR.getResponseHeader('Etag'));
	        // console.log('fail');
	        // console.log(jqXHR);
	    });
	} else if (element.hasClass('tantan') && !element.hasClass('disable')) {
	    chkElement = element.find('input[type=checkbox]');
	    chkElement.click();
	} else if (element.attr('id') == 'plusz' || element.attr('id') == 'minusz') {
	    element.find('ul.limit').slideToggle(85);
	} else if (element.hasClass('setLimit')) {
	    spanElement = element.closest('span');
	    ulElement = element.closest('ul.limit');
	    ulElement.slideUp().detach();
	    spanElement.html(' '+element.html());
	    ulElement.appendTo(spanElement);
	    plusz=parseInt($('div#statusz span#plusz').html());
	    minusz=parseInt($('div#statusz span#minusz').html());
	    checkOraszam(plusz, minusz);
	} else if (element.hasClass('targy')) {
	    targyId = element.data('targyid');
	    szurtTargyId = $('table#tt').data('szurtTargyId');
	    if (szurtTargyId == targyId) {
		// szűrés megszüntetése
		$('table#tt tr.tanar').not('.targy'+szurtTargyId).removeClass('szurt');
		$('table#tt').data('szurtTargyId','');
	    } else {
		// szűrni kell
		if (szurtTargyId != '') {
		    // egy másik szűrés volt eddig - megszűntettjük
		    $('table#tt tr.tanar').not('.targy'+szurtTargyId).removeClass('szurt');
		}
		$('table#tt tr.tanar').not('.targy'+targyId).addClass('szurt');
		$('table#tt').data('szurtTargyId',targyId);
	    }
	    // szűrés miatt az első látható cella eltűnhet, módosulhat
	    if ($('tr.tanar.first').hasClass('szurt')) {
		trElements = $('tr.tanar.first').nextAll('tr.tanar').not('.szurt').get();
		if (trElements.length>0) {
		    $('tr.tanar.first').removeClass('first');
		    $(trElements[0]).addClass('first');
		} else {
		    // ha nincs lefele látható sor, akkor felfelé keresünk...
		    trElements = $('tr.tanar.first').prevAll('tr.tanar').not('.szurt').get();
		    if (trElements.length>0) {
			$('tr.tanar.first').removeClass('first');
			$(trElements[0]).addClass('first').removeClass('csukott');
			$(trElements[0]).nextAll('tr').removeClass('csukott');
		    }
		}
	    }
	} else if (element.hasClass('unset')) {
	    element.closest('div').find('input[type=checkbox]:checked').click();
	} else if (element.hasClass('toggleKesz')) {
/* ez meg nem mukodik
	    $('table#tt td.tankor.kesz').each(function(index) {
		className = 'col-'+$(this).data('tankorid');    
		$('table#tt td.tantan.'+className).toggleClass('szurt');
		$(this).toggleClass('szurt');
		thTargy = $('table#tt th#thTargy-'+$(this).data('targyid'));
		colSpan = $('table#tt td.tdTargy-'+$(this).data('targyid')).not('.szurt').length;
		thTargy.prop('colspan',colSpan);
		if (colSpan==0) thTargy.addClass('szurt');
		else thTargy.removeClass('szurt');
	    });
*/
	}

    });

    $('body').change(function(event) {

	element = $(event.target);

	if (element.hasClass('szOsztaly')) {
	    if (element.prop('checked')) {
		$('#szuro').data('szuro').osztalyIds.push( element.val() );
		$('<span id="selOsztalyId-'+element.val()+'"> '+element.next('label').html()+'</span>').insertAfter('div#szOsztaly strong');
	    } else {
		$('div#szOsztaly span#selOsztalyId-'+element.val()).prev('br').remove();
		$('div#szOsztaly span#selOsztalyId-'+element.val()).remove();
		tmp = $('#szuro').data('szuro').osztalyIds;
		$('#szuro').data('szuro').osztalyIds = [];
		for (i=0; i<tmp.length; i++) if (tmp[i] != element.val()) $('#szuro').data('szuro').osztalyIds.push(tmp[i]);
	    }
	} else if (element.hasClass('szMk')) {
	    if (element.prop('checked')) {
		$('#szuro').data('szuro').mkIds.push( element.val() );
		$('<br /><span id="selMkId-'+element.val()+'"> '+element.next('label').html()+'</span>').insertAfter('div#szMk strong');
	    } else {
		$('div#szMk span#selMkId-'+element.val()).prev('br').remove();
		$('div#szMk span#selMkId-'+element.val()).remove();
		tmp = $('#szuro').data('szuro').mkIds;
		$('#szuro').data('szuro').mkIds = [];
		for (i=0; i<tmp.length; i++) if (tmp[i] != element.val()) $('#szuro').data('szuro').mkIds.push(tmp[i]);
	    }
	} else if (element.hasClass('szTanar')) {
	    if (element.prop('checked')) {
		$('#szuro').data('szuro').tanarIds.push( element.val() );
		$('<br /><span id="selTanarId-'+element.val()+'"> '+element.next('label').html()+'</span>').insertAfter('div#szTanar strong');
	    } else {
		$('div#szTanar span#selTanarId-'+element.val()).prev('br').remove();
		$('div#szTanar span#selTanarId-'+element.val()).remove();
		tmp = $('#szuro').data('szuro').tanarIds;
		$('#szuro').data('szuro').tanarIds = [];
		for (i=0; i<tmp.length; i++) if (tmp[i] != element.val()) $('#szuro').data('szuro').tanarIds.push(tmp[i]);
	    }
	} else if (element.hasClass('szTargy')) {
	    if (element.prop('checked')) {
		$('#szuro').data('szuro').targyIds.push( element.val() );
		$('<br /><span id="selTargyId-'+element.val()+'"> '+element.next('label').html()+'</span>').insertAfter('div#szTargy strong');
	    } else {
		$('div#szTargy span#selTargyId-'+element.val()).prev('br').remove();
		$('div#szTargy span#selTargyId-'+element.val()).remove();
		tmp = $('#szuro').data('szuro').targyIds;
		$('#szuro').data('szuro').targyIds = [];
		for (i=0; i<tmp.length; i++) if (tmp[i] != element.val()) $('#szuro').data('szuro').targyIds.push(tmp[i]);
	    }
	} else if (element.closest('div').hasClass('slideToggleContainer')) {
	    element.closest('div').find('span.tankorData').addClass('changed');
	    $('#updateWindowSideContent p.tankorModosit').slideDown();
	} else if (element.attr('id')=='tankorNevExtra') {
	    if (!element.prev('span.tankorNevExtra').hasClass('changed')) {
		element.prev('span.tankorNevExtra').addClass('changed');
		$('#updateWindowSideContent p.tankorModosit').slideDown();
	    }
	} else if (element.hasClass('chkTT')) {
	    saltName = $('#updateForm input.salt').prop('name');
	    saltValue = $('#updateForm input.salt').val();
	    var chkData = element.val().split('_');
    	    var tanarId = chkData[0];
    	    var tankorId = chkData[1];
    	    if(element.prop('checked')) ajaxAction='tankorTanarFelvesz';
    	    else ajaxAction='tankorTanarTorol';

    	    var postData = { 'action':ajaxAction ,'tankorId':tankorId, 'tanarId':tanarId, 'sessionID':sessionID, 'mayorToken': ($('body').data('mayortoken')) };
    	    postData[saltName] = saltValue;

    	    $('#cell_'+tanarId+'_'+tankorId).animate({backgroundColor: '#aaaaaa'}, 10);
    	    // TODO: a requestet meg kellene várnunk! ??
    	    $.ajax({
                type: "POST",
                url: "?page=naplo&sub=intezmeny&f=tankorTanarHozzarendeles&policy=private&skin=ajax&sessionID="+sessionID,
                data: postData,
                dataType: 'json'
    	    }).done(function( msg, status, jqXHR ) {
		processJSONChk(msg, element, tanarId, tankorId);
                updateSalt(jqXHR.getResponseHeader('Etag'));
    	    }).fail(function(jqXHR, textStatus) {
                displayJSONerror(jqXHR.responseJSON);
                updateSalt(jqXHR.getResponseHeader('Etag'));
                $('#cell_'+tanarId+'_'+tankorId + ' > input').attr('checked',false);
                $('#cell_'+tanarId+'_'+tankorId).animate({backgroundColor: '#ff0000'}, 100).animate({backgroundColor: '#eeeeee'}, 1000);
    	    });

	}

    });

    $('body').focusout(function(event) {
	var element = $(event.target);
	if (element.attr('id')=='tankorNevExtra') {
	    element.prev('span.tankorNevExtra').html( element.val() ).show();
	    element.hide();
	}
    });

    $('#updateWindowSide').on('keydown', 'ul#tankorSzemeszter li:last-child input', function(event) {

	var charKeyCode = event.keyCode ? event.keyCode : event.which;
	var shiftKey = event.shiftKey ? event.shiftKey : ((charKeyCode == 16) ? true : false);
	var altKey = event.altKey ? event.altKey : ((charKeyCode == 18) ? true : false);
	var ctrlKey = event.ctrlKey ? event.ctrlKey : ((charKeyCode == 17) ? true : false);
	element = $(event.target);

	if (charKeyCode == 9) {
	    event.preventDefault();
	    tmp = element.attr('name').split('-');
	    tanev = 1+parseInt(tmp[1]); 
	    for (szemeszter = 1; szemeszter<3; szemeszter++) {
		$('<li>'+tanev+'/'+szemeszter
		    +'<input maxlength="5" type="text" name="sz-'+tanev+'-'+szemeszter+'" value="" />'
		    +'</li>').appendTo('ul#tankorSzemeszter');
	    }
	    element.closest('li').next('li').find('input').focus();
	}

    });
    $('#updateWindowSide').on('keydown', 'ul#tankorSzemeszter li:first-child input', function(event) {

	var charKeyCode = event.keyCode ? event.keyCode : event.which;
	var shiftKey = event.shiftKey ? event.shiftKey : ((charKeyCode == 16) ? true : false);
	var altKey = event.altKey ? event.altKey : ((charKeyCode == 18) ? true : false);
	var ctrlKey = event.ctrlKey ? event.ctrlKey : ((charKeyCode == 17) ? true : false);
	element = $(event.target);

	if (charKeyCode == 9 && shiftKey) {
	    event.preventDefault();
	    tmp = element.attr('name').split('-');
	    tanev = parseInt(tmp[1])-1; 
	    for (szemeszter = 1; szemeszter<3; szemeszter++) {
		$('<li>'+tanev+'/'+szemeszter
		    +'<input maxlength="5" type="text" name="sz-'+tanev+'-'+szemeszter+'" value="" />'
		    +'</li>').prependTo('ul#tankorSzemeszter');
	    }
	    element.closest('li').prev('li').find('input').focus();
	}

    });


    $('body').keydown(function(event) {

	var charKeyCode = event.keyCode ? event.keyCode : event.which;
	var shiftKey = event.shiftKey ? event.shiftKey : ((charKeyCode == 16) ? true : false);
	var altKey = event.altKey ? event.altKey : ((charKeyCode == 18) ? true : false);
	var ctrlKey = event.ctrlKey ? event.ctrlKey : ((charKeyCode == 17) ? true : false);
	element = $(event.target);

	if (!$('#updateWindowSide').hasClass('nyitva')) {
	if (charKeyCode == 37) { // balra
	    event.preventDefault();
	    firstTh = $('table#tt th.first.targy');
	    firstColspan = firstTh.attr('colspan');
	    if (firstColspan < firstTh.data('colspan')) {
		firstTh.attr('colspan', ++firstColspan);
	    } else {
		if (firstTh.prev('th.targy').length > 0) {
		    firstTh.removeClass('first');
		    firstTh.prev('th.targy').addClass('first').show();
		}
	    }
	    firstTd = $('table#tt td.first');
	    if ($('table#tt td.first.tankor').prev('td.tankor').length>0) {
		firstTd.removeClass('first');
		firstTd.prev('td').addClass('first').show();
	    }
	} else if (charKeyCode == 39) { // jobb
	    event.preventDefault();
	    firstTh = $('table#tt th.first.targy');
	    firstColspan = firstTh.attr('colspan');
	    if (firstColspan > 1) {
		firstTh.attr('colspan', firstColspan-1);
	    } else {
		if (firstTh.next('th.targy').length > 0) {
		    firstTh.removeClass('first').hide();
		    firstTh.next('th.targy').addClass('first');
		}
	    }
	    firstTd = $('table#tt td.first');
	    if ($('table#tt td.first.tankor').next('td.tankor').length>0) {
		firstTd.removeClass('first').hide();
		firstTd.next('td').addClass('first');
	    }
	} else if (charKeyCode == 40) { // le
	    event.preventDefault();
	    firstTr = $('table#tt tr.first.tanar');
	    nextTrs = firstTr.nextAll('tr').not('.szurt').get();
	    if (nextTrs.length>0) {
		firstTr.removeClass('first');
		$(nextTrs[0]).prevAll('tr.tanar').addClass('csukott');
		$(nextTrs[0]).addClass('first');
	    }
	} else if (charKeyCode == 38) { // fel
	    event.preventDefault();
	    firstTr = $('table#tt tr.first.tanar');
	    prevTrs = firstTr.prevAll('tr').not('.szurt').get();
	    if (prevTrs.length>0) {
		firstTr.removeClass('first');
		$(prevTrs[0]).addClass('first').removeClass('csukott');
		$(prevTrs[0]).nextAll('tr.tanar').removeClass('csukott');
	    }
	}} // updateWindowSide - !nyitva
    });

});