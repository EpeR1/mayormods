
// Event.observe(window, 'load', myPSFLoader, false);

$(function() {
    var eDid = $('#did');
    $('.check').bind('click',function(event) {
	if (eDid.val() == '') {
	    alert(eDid.prop('title'));
	    event.preventDefault();
	}
    });
    $('body').bind('keyup', function(event) {
	var element = $(event.target);
	var charKeyCode = event.keyCode ? event.keyCode : event.which;
	if ($('#updateWindow').is(':visible')) { // csak akkor érdekes, ha ott van az ablak
	    if(!element.is('input') && !element.is('textarea') && !element.is('select')) { // input elem esetén ne legyen semmi
        	if (charKeyCode==46) { // Del gomb
		    $('#jegyTorles').click();
		}
	    }
	}
    });
    $('.felevLezar').bind('click', function(event) {
	var element = $(event.target);
//	console.log(element.data('szemeszter'));
//	console.log($.find('.atlag'));
    });

});

showUpdateLayer = function(options) {
    if (options.submitClass != 'onSubmitUpdate') { // A már megnyitott form frissítésekor ne méretezzünk át!
	if (options.submitClass == 'onClickUpdateWindow szoveges') {
	    $('#updateWindow').css({'height':'90%', 'top': '60px'});
	} else {
    	    $('#updateWindow').css({'height':'500px', 'top':'200px'});
	}
    }
    takaroElem = $('#takaro');
    if (takaroElem) takaroElem.show();
    $('#updateWindow').show();
    $('#updateForm').prop('tabindex',1);
    $('#updateForm').focus();
}

processJSON = function(json) {
    if (json.action == 'jegyModositas') {
	var tdElement = $('#td-'+json.data.diakId+'-'+json.data.dolgozatId);
	var aElement = $('#jegy-'+json.data.jegyId);
	if (typeof aElement.closest('td').attr('id') !== 'undefined') { 
	    var oldDid = (aElement.closest('td').attr('id').split('-'))[2]; 
	}

	if (tdElement) tdElement.append(aElement); // áthelyzés a megfelelő dolgozat alá
	aElement.removeClass('jegy1');
	aElement.removeClass('jegy2');
	aElement.removeClass('jegy3');
	aElement.removeClass('jegy4');
	aElement.removeClass('jegy5');
	aElement.addClass('jegy'+json.data.tipus);
	aElement.html(json.data.jegyStr); // jegy módosítása

	if (json.data.dolgozatId != oldDid) updateDolgozatAtlag(oldDid); // eredeti dolgozat átlaga
	updateDolgozatAtlag(json.data.dolgozatId); // új dolgozat átlaga

	$('#updateWindow').hide();
	$('#takaro').hide();
    } else if (json.action == 'jegyTorles') {
	var aElement = $('#jegy-'+json.data.jegyId);
	aElement.remove();
	$('#updateWindow').hide();
	$('#takaro').hide();
    } else {
	alert('processJSON: ismeretlen visszatérési érték!');
    }
}

updateDolgozatAtlag = function(did) {
	var sum=0, db=0;
	$('td.d'+did+' a').each(function(index) {
	    sum = sum + parseInt($(this).text()); db++;
	    if ($(this).html().indexOf('/')>-1) sum = sum + 0.5;
	});
	avg=(sum/db);
	avgElement = $('#avg-d'+did);
	if (avgElement) avgElement.html(avg.toFixed(2));
}


// -- ELAVULT -- de hiányzik a mozgatás!!//

function myPSFLoader(evt) {

   // Csoportos jegy beírásakor ellenőrizzük, hogy ki lett-e választva dolgozat
    var CheckDolgozatObject = Class.create();
    CheckDolgozatObject.prototype = {
        initialize: function(element) {
            this.element = $(element);
	    this.eDid = $('did');
            this.element.observe('click',this.checkDolgozat.bindAsEventListener(this));
        },

        checkDolgozat: function(evt, extraInfo) {

    	    if (this.eDid.value == '') {
        	alert(this.eDid.getAttribute('title'));
		Event.stop(evt);
    	    }

        }
    }

    var checkDolgozatElements = new Array();
    $$('.check').each(
        function (elem, index) {
            checkDolgozatElements.push(new CheckDolgozatObject(elem));
        }
    );

    Event.observe(document.body, 'keyup', function(event) {
        var element = $(Event.element(event));
        var charKeyCode = event.keyCode ? event.keyCode : event.which;
        // input elem esetén ne legyen semmi
        if(!element.match('input') && !element.match('textarea') && !element.match('select')) {
            if (charKeyCode==46 && $('updateWindow').visible()) { // Del gomb
		$('jegyTorles').click();
	    }
	}
    });

//    var mydrag = new Draggable('updateWindow', { scroll: window, handle: $('updateHeader') });
}
