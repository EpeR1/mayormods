
$(function() {
    initTemakorLista();
    // mozgatás
    $('#temakor').sortable({ axis: 'y', containment: "#temakor", handle: "span.handle", items: ".sortable", scroll: false,
	placeholder: "sortable-placeholder" ,
	cursor:'move',
	opacity:0.2,
	stop: function(event, ui) { initTemakorLista(); $('form[name=tanmenetMod]').trigger('change'); }
    } );
    // törlés
    $('body').click(function(event) {
        var element = $(event.target);
        if (element.hasClass('close')) {
	    element.closest('li').remove();
	    initTemakorLista();
	    $('form[name=tanmenetMod]').trigger('change');
        }
    });
    // óraszám  vagy szöveg módosítás
    $('body').change(doOnTemakorChange);
    // a textarea kinyitása és visszacsukása
    $('#temakor textarea').focus(function(event) {
	    $(event.target).css({ 'background-color': '#eed', 'height': '100px' });	
    }).blur(function(event) {
	    $(event.target).css({ 'background-color': '#fff', 'height': '50px' });	
    });

});


initTemakorLista = function() {

	var oraszam = 0;
	var maxoraszam = parseInt($('#tanmenetOraszam').val());
	// Az eddigi összóraszám meghatározása
	var osszoraszam = 0;
        $('span.handle').each(
            function(index, elem) {
		selectElem = $(elem).closest('li').find('select'); textElem = $(elem).closest('li').find('textarea');
		if (selectElem.val() != '0' && textElem.val() != '') osszoraszam = osszoraszam+parseInt(selectElem.val());
            }
        );
	var szabadoraszam = maxoraszam-osszoraszam;
	if (szabadoraszam<0) szabadoraszam=0;

	// Az egyes témakörök sorainak beállítása
        $('span.handle').each(
            function(index, elem) {

		elem = $(elem); selectElem = elem.closest('li').find('select'); 
		textElem = elem.closest('li').find('textarea'); oraszamSpan = elem.closest('li').find('span.oraszam');
		if (selectElem.val() != '0' && textElem.val() != '') { // Már kitöltött témakör esetén
		    // Mivel nem tudjuk, hogy korábban milyen osztályba volt sorolva ezért mindkét osztályból eltávolítjuk
		    oraszamSpan.removeClass('jo');		// jo: még belefér az óraszámba
		    oraszamSpan.removeClass('nagy');	// nagy: már nem fér bele az óraszámba
		    // A témakör által lefoglalt órák kiírása
            	    oraszamSpan.html( (oraszam+1) );
		    oraszam = oraszam+parseInt( selectElem.val() );
            	    oraszamSpan.append('-'+oraszam);
		    // osztályokba sorolás
		    if (oraszam > maxoraszam) oraszamSpan.addClass('nagy');	// már nem fér bele a tanmenet óraszámába
		    else oraszamSpan.addClass('jo');				// még belefér a tanmenet óraszámába
		    // Az oraszám-select érvényes óraszámokra való leszűkítése
		    value = parseInt(selectElem.val());
		    selectElem[0].options.length = 0;
		    for (k=0; k<value+szabadoraszam+1; k++) {
			selectElem[0].options[k] = new Option(k, k, (k==value), (k==value));
		    }
		} else { // Az üres, utolsó bejegyzés beállítása
		    if (oraszam < maxoraszam) { // ha van még szabad óra
			// A hátralévő, szabad órák kiírása
			oraszamSpan.html( (oraszam+1) );
			oraszamSpan.append( '-'+maxoraszam );
			textElem.prop('disabled', false);		// Az esetleg korábban letiltott textarea elem engedélyezése
		    } else {
			oraszamSpan.html('-');		// nincs már szabad óra
			textElem.prop('disable', true);		// textarea	 elem letiltása - nem lehet felvenni újabb témakört
		    }
		    // A fennmaradt szabad óraszámhoz igazítás
		    selectElem[0].options.length = 0;
		    for (k=0; k<szabadoraszam+1; k++) {
			selectElem[0].options[k] = new Option(k, k, (k==0), (k==0));
		    }
		}
            }
        );

}

//
// Ha változik valamelyik témakör szövege, vagy óraszáma, akkor fut le ez a függvény
//
doOnTemakorChange = function(event) {
       
        var element = $(event.target);
	// Óraszzámváltozáskor újrainicializáljuk a listát...
        if (element.hasClass('temakorOraszam')) {
            initTemakorLista();
        }
	// Új témakör felvételekor
	if (element.hasClass('uj')) {
		spanElement = element.closest('li').find('span.oraszam');
		selectElement = spanElement.next('select');
		textElement = selectElement.next('textarea');
		if (selectElement.val() != '0' && textElement.val() != '') { // Ha érvényes bejegyzés keletkezett
		    // Létrehozunk egy új, üres témakör-beviteli lehetőséget
		    newLi = element.closest('li').clone();
		    // Az eddigi 'uj' mostantól már nem új...
		    selectElement.removeClass('uj');
		    textElement.removeClass('uj');
		    // hanem egy érvényes témakör -aminek óraszámát figyelembe kell venni
		    selectElement.addClass('temakorOraszam');
		    // és a bejegyzést mozgathatóvá, rendezhetővé kell tenni
		    element.closest('li').addClass('sortable');
		    // Az új elemet felvesszük a lista végére
		    element.closest('ul').append(newLi);
		    $(newLi).find('select').focus();
		    // inicializáljuk a listát - hisz lett egy új érvényes óraszámunk
		    initTemakorLista();
		}
	}

}


