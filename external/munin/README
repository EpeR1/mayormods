
Munin monitorozó plugin a mayorhoz

Grafikonokat készít a "munin" program segítségével a Mayor pillanatnyi állapotáról.
Egyelőre csak debian 9+ rendszeren tesztelt, de pár apró módosítással életrekelthető más rendszereken is.

Rögzíti az:
--  Egyidejűleg (pillanatnyi) bejelentkezett felhasználók számát.
--  IP-cím alapján a lokális (192.168.*.*, 10.*.*.*, 172.16.*.*, fd**::/8) és külön a külső tartományokat.
--  Policy alapján a 'private' és/vagy 'parent' -ben belépett felhasználókat.
--  Aktivitás alapján az Xperc (pl:10perc) ideje, a 2*Xperc ideje aktív felhasználókat és a tétleneket.


Beállítása a következő: (debian)

1.lépés: >>> apt-get install munin
2.lépés: a "/etc/munin/munin.conf" fájl szerkesztése a következő módon:

--(I.)	először keressük meg a következő részt: 
		# a simple host tree
		[localhost.localdomain]
		    address 127.0.0.1
		    use_node_name yes

--      módosítsuk a "localhost.localdomain"-t a napló-szerver gépnevének megfelelően:
	(itt az FQDN (teljes elérési út szükséges))
		[gépnév.iskolaneve.hu]
		    address 127.0.0.1
		    use_node_name yes

--(II.)	ugyanitt, adjuk hozzá a következő sorokat:
	(és írjuk át a "mayor.iskolaneve.hu" címet a napló címének megfelelően)
		[mayor.iskolaneve.hu]
		    address 127.0.0.1
		    use_node_name no


--(III.) ezután módosítanunk kell a "mayor_munin.php" scriptben a "$set['naplo_host'] = "mayor.iskolaneve.hu";"-t 
	(első sorok egyike) a saját naplónk címének megfelelően.
	Ez egy fontos beállítás, mert ezen keresztül ismeri fel a munin rendszer a mi
	monitorozó scriptünket.


--(IV.)	utána másoljuk a "mayor_munin.php"-t az: 	
	az /usr/share/munin/plugins/ mappába vagy
	az /etc/munin/ könyvtárba vagy
	bárhova, ahonnan a munin eléri.

	FONTOS!!
	A "mayor_munin.php"-nak állítsuk be a "root" tulajdonost és 700-as jogokat!
	(nehogy valami kiolvassa a jelszót)


--(V.) 	ezután el kell helyezni egy simlink-et a /etc/munin/plugins/ könyvtárba, ami a bemásolt fájlra mutat.
	pl: ln -s /usr/share/munin/plugins/mayor_munin.php /etc/munin/plugins/munin


--(VI.) végül be kell állítanunk egy felhasználót, a mysql-ben, amivel olvasni lehet a mayor_login.session és a mayor_login.loginLog táblákat
	(például:)
	mysql>	GRANT SELECT ON  mayor_login.loginLog  TO 'mayor-monitor'@'localhost' IDENTIFIED BY 'erőős-jelszóó!';
	mysql>	GRANT SELECT ON  mayor_login.session   TO 'mayor-monitor'@'localhost' IDENTIFIED BY 'erőős-jelszóó!';

-	Lehetőség van mysql/unix_socket authentikációra is, ez nagyban növeli biztonságot, mert nem alkalmaz jelszót, 
	így szinte lehetetlen próbálgatással feltörni.
	Fontos, hogy a kiválasztott felhasználónak/felhasználónévnek valósnak kell lenni, és léteznie kell a rendszerben.
	Egyszerűség kedvéért használhatjuk a "root" felhasználót, ez eredetileg is unix_socket-tel authentikál a mysql-ben,
	(hacsak a mysql telepítésénél meg nem változtattuk)

	vagy a "munin" nevű felhasználót, ezt adjuk hozzá a mysql-hez:

	mysql> GRANT SELECT ON  mayor_login.session  TO 'munin'@'localhost' IDENTIFIED via unix_socket;
	mysql> GRANT SELECT ON  mayor_login.loginLog  TO 'munin'@'localhost' IDENTIFIED via unix_socket;

	majd rá kell venni a munin-t, hogy a "munin" felhasználónévvel futtassa, ezt a "/etc/munin/plugin-conf.d/munin-node"
	fájlba kell beírni, a következő sorok hozzáadásával:
	
	[mayor_munin]
	   user munin

	Fontos: ekkor a mayor_munin.php tulajdonosát a "munin"-ra kell állítani!



--(VII.) Finomhangolás:
	Végül írjuk be a "mayor_munin.php" elejére, a "$set['___']" tömböt módosítva, a maysql adatokat, 
	illetve itt tudjuk beállítani az aktivitáshoz számolt időt percben, és a napló webcímét is.


--(VIII.) Befejezésképpen pedig indítsuk újra a munin-t az alábbi parancsokkal:
	>>> /etc/init.d/munin-node restart 
	>>> /etc/init.d/munin restart 
	

--(++) a beálítás végeztével a következő paranccsal ellenőrizhetjük, hogy mindent jól csináltunk-e:
	>>> munin-run mayor_munin
	
	Ekkor egy listát kapunk, ahol a változók nevei ("mayor_xxxx_xx.values") mellett számértékeket látunk,
	ha semmi, vagy a számok helyett egy "U" betű jelenik meg, akkor még valamit finomhangolni kell.
